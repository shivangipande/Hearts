<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythms of Life - Animal Heartbeat Database</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: rgba(0,0,0,0.9);
            --bg-tertiary: #333;
            --text-primary: white;
            --text-secondary: #ccc;
            --border-color: #555;
            --accent-color: #ff4444;
        }
        
        [data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: rgba(255,255,255,0.95);
            --bg-tertiary: #e0e0e0;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ccc;
            --accent-color: #d63384;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            font-family: 'Ginto', Arial, Helvetica, sans-serif;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .header {
            background: var(--bg-secondary);
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            backdrop-filter: blur(10px);
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .controls input, .controls select, .controls button {
            padding: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: 'Ginto', Arial, Helvetica, sans-serif;
            transition: all 0.2s ease;
        }
        
        .controls select {
            padding-right: 35px;
        }
        
        .controls input {
            width: 200px;
        }
        
        .controls button {
            cursor: pointer;
            background: var(--bg-tertiary);
        }
        
        .controls button:hover {
            background: var(--accent-color);
        }
        
        .toggle-btn {
            background: var(--accent-color) !important;
        }
        
        .toggle-btn.active {
            background: #28a745 !important;
        }
        
        .info {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: 12px;
            text-align: right;
        }
        
        #canvas-container {
            margin-top: 0;
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 12px;
            pointer-events: none;
            z-index: 1000;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            max-width: 250px;
            display: none;
        }
        
        .tooltip h4 {
            margin: 0 0 8px 0;
            color: var(--accent-color);
            font-size: 14px;
        }
        
        .tooltip .stat {
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .tooltip .stat-label {
            color: var(--text-secondary);
        }
        
        .tooltip .stat-value {
            color: var(--text-primary);
            font-weight: bold;
        }
        
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .export-content {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            max-width: 400px;
            min-width: 320px;
            width: auto;
            box-sizing: border-box;
        }
        
        .export-content h3 {
            margin-top: 0;
            color: var(--accent-color);
        }
        
        .export-options {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .export-options button {
            padding: 12px 18px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Ginto', Arial, Helvetica, sans-serif;
            font-size: 14px;
            white-space: nowrap;
            min-width: 140px;
        }
        
        .export-options button:hover {
            background: var(--accent-color);
        }
        
        .embed-code {
            width: 100%;
            height: 100px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            font-family: 'Ginto', Arial, Helvetica, sans-serif;
            font-size: 11px;
            resize: vertical;
        }
        
        .intro-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(3px);
            text-align: center;
            padding: 40px;
        }
        
        .intro-poem {
            color: white;
            font-size: 24px;
            line-height: 1.6;
            font-style: italic;
            font-family: 'Playfair Display', serif;
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
            margin-bottom: 40px;
            max-width: 600px;
            font-weight: 300;
        }
        
        .intro-arrow {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .intro-arrow:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .intro-arrow::after {
            content: 'ENTER';
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: normal;
            font-style: normal;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                padding: 10px;
            }
            
            .controls {
                justify-content: center;
                gap: 10px;
            }
            
            .controls input {
                width: 150px;
            }
            
            .controls button {
                padding: 10px;
                font-size: 16px;
                min-width: 44px;
                min-height: 44px;
            }
            
            .info {
                text-align: center;
                font-size: 11px;
            }
            
            .intro-poem {
                font-size: 18px;
                padding: 0 20px;
            }
            
            .intro-arrow {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .intro-arrow::after {
                font-size: 16px;
                content: 'ENTER';
            }
            
            .tooltip {
                max-width: 200px;
                font-size: 11px;
            }
            
            .export-content {
                margin: 10px;
                max-width: none;
                width: calc(100% - 20px);
            }
            
            .export-options button {
                min-width: 120px;
                padding: 12px 16px;
            }
            
            footer {
                padding: 15px 10px !important;
                font-size: 11px !important;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="header">
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search animals..." />
            <select id="sortSelect" title="Sort by">
                <option value="alphabetical">üî§ Name</option>
                <option value="heartrate">üíì BPM</option>
                <option value="size">üìè Size</option>
            </select>
            <button id="cleanViewBtn" class="toggle-btn" onclick="toggleCleanView()" title="Toggle clean view">üßπ</button>
            <button id="themeBtn" onclick="toggleTheme()" title="Toggle theme">üåô</button>
            <button onclick="showExportModal()" title="Export options">üì§</button>
        </div>
        
        <div class="info">
            <div>
                <strong>Rhythms of Life</strong><br>
                <small>An interactive map of animal heartbeats</small><br>
                <small>Dot size = heart mass ‚Ä¢ Flicker rate = BPM ‚Ä¢ Hover for audio</small>
            </div>
        </div>
    </div>
    
    <div id="canvas-container">
        <div id="tooltip" class="tooltip"></div>
    </div>
    
    <footer style="background: var(--bg-secondary); padding: 20px; border-top: 1px solid var(--border-color); text-align: center; font-size: 12px; margin-top: 5px;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <p style="margin: 0 0 15px 0; color: var(--text-secondary); line-height: 1.4;">
                This interactive experience explores the fascinating diversity of cardiovascular systems across the animal kingdom. 
                From the ultra-rapid 1400+ BPM hearts of tiny insects to the slow, powerful 26 BPM hearts of large birds, 
                each species has evolved a unique cardiac solution for survival.
            </p>
            <p style="margin: 0; color: var(--text-secondary);">
                <a href="#" onclick="requestAnimal(); return false;" style="color: var(--accent-color); text-decoration: none;">üêæ Request More Animals</a> | 
                Made with love by <a href="https://www.linkedin.com/in/pandeshivangi/" target="_blank" style="color: var(--accent-color); text-decoration: none;">Shivangi Pande</a>
            </p>
        </div>
    </footer>
    
    <div id="exportModal" class="export-modal">
        <div class="export-content">
            <h3>Export & Share</h3>
            <div class="export-options">
                <button onclick="exportScreenshot()">üì∏ Download PNG</button>
                <button onclick="copyLink()">üîó Copy Link</button>
                <button onclick="pledgeToProtect()">üõ°Ô∏è Pledge to Protect</button>
            </div>
            <div style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 12px;">
                Tap outside to close
            </div>
        </div>
    </div>
    
    <div id="introModal" class="intro-modal">
        <div class="intro-poem">
            Some hearts flicker like flames. Others echo slowly, like the earth breathing.
        </div>
        <div class="intro-arrow" onclick="closeIntroModal()"></div>
    </div>
    
    <script>
        let allAnimals = [];
        let visibleAnimals = [];
        let currentSort = 'alphabetical';
        let searchTerm = '';
        let cols = 8;
        let rows = 6;
        let canvasWidth = window.innerWidth;
        let canvasHeight = window.innerHeight - 200; // Reserve space for header + footer
        let cleanView = false;
        let isDarkTheme = true;
        let hoveredAnimal = null;
        let tooltip;
        let isAscending = true;
        let audioContext;
        let currentHeartbeatInterval;
        let isAudioEnabled = false;
        
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                isAudioEnabled = true;
            } catch (e) {
                console.log('Web Audio API not supported');
                isAudioEnabled = false;
            }
        }
        
        function createHeartbeat(bpm) {
            if (!isAudioEnabled || !audioContext) return;
            
            try {
                // Create oscillator for the heartbeat sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // Connect audio nodes
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Configure heartbeat sound - different frequencies for different BPM ranges
                let baseFreq;
                if (bpm < 50) {
                    // Very slow hearts get deeper, more powerful sound
                    baseFreq = 50;
                } else if (bpm < 100) {
                    // Medium hearts
                    baseFreq = 70;
                } else if (bpm < 200) {
                    // Fast hearts
                    baseFreq = 90;
                } else {
                    // Very fast hearts get higher pitch
                    baseFreq = 110;
                }
                
                oscillator.frequency.setValueAtTime(baseFreq, audioContext.currentTime);
                oscillator.type = 'sine';
                
                // Create heartbeat envelope - longer for slow hearts, shorter for fast
                const now = audioContext.currentTime;
                const duration = bpm < 60 ? 0.25 : 0.15; // Longer sound for slow hearts
                const volume = bpm < 60 ? 0.5 : 0.4; // Louder for slow hearts
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume, now + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
                
                // Play the sound
                oscillator.start(now);
                oscillator.stop(now + duration);
            } catch (error) {
                console.log('Audio playback error:', error);
            }
        }
        
        function startHeartbeatAudio(animal) {
            if (!isAudioEnabled || currentHeartbeatInterval) return;
            
            // Store current animal for volume calculation
            window.currentAnimal = animal;
            
            // Calculate interval but set reasonable limits for user experience
            const rawInterval = 60000 / animal.bpm;
            let interval;
            
            // Cap the maximum interval so slow hearts don't have huge gaps
            if (rawInterval > 800) {
                // For very slow hearts, cap at 800ms max (75 BPM equivalent)
                interval = 800;
                console.log(`üêò Slow heart ${animal.name}: ${animal.bpm} BPM (${rawInterval}ms) capped to ${interval}ms`);
            } else if (rawInterval < 150) {
                // For very fast hearts, minimum 150ms to avoid audio overlap
                interval = 150;
                console.log(`üêú Fast heart ${animal.name}: ${animal.bpm} BPM (${rawInterval}ms) increased to ${interval}ms`);
            } else {
                interval = rawInterval;
                console.log(`üíì Normal heart ${animal.name}: ${animal.bpm} BPM using ${interval}ms`);
            }
            
            // Play first beat immediately
            createHeartbeat(animal.bpm, animal.name);
            
            // Set up repeating heartbeat with adjusted timing
            currentHeartbeatInterval = setInterval(() => {
                createHeartbeat(animal.bpm, animal.name);
            }, interval);
        }
        
        function stopHeartbeatAudio() {
            if (currentHeartbeatInterval) {
                clearInterval(currentHeartbeatInterval);
                currentHeartbeatInterval = null;
            }
        }
        
        function setup() {
            let canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('canvas-container');
            
            // Comprehensive collection of animals - including all food animals
            allAnimals = [
                // Small insects (fast hearts)
                {name: "ANT", bpm: 418, size: 5, heartMass: "0.0g", scientificName: "Myrmecia croslandi", category: "Insect", lifespan: "1-2 years"},
                {name: "GRASSHOPPER", bpm: 391, size: 6, heartMass: "0.0g", scientificName: "Schistocerca gregaria", category: "Insect", lifespan: "6-12 months"},
                {name: "MOTH", bpm: 369, size: 7, heartMass: "0.0g", scientificName: "Manduca sexta", category: "Moth", lifespan: "2-6 weeks"},
                {name: "BEE", bpm: 318, size: 8, heartMass: "0.0g", scientificName: "Bombus impatiens", category: "Insect", lifespan: "6 months"},
                
                // Amphibians & Marine
                {name: "FROG", bpm: 144, size: 15, heartMass: "0.04g", scientificName: "Rana clamitans", category: "Amphibian", lifespan: "8-10 years"},
                {name: "FISH", bpm: 380, size: 12, heartMass: "1g", scientificName: "Small fish species", category: "Fish", lifespan: "2-5 years"},
                {name: "SALMON", bpm: 120, size: 28, heartMass: "25g", scientificName: "Salmo salar", category: "Fish", lifespan: "4-6 years"},
                {name: "TUNA", bpm: 140, size: 45, heartMass: "180g", scientificName: "Thunnus thynnus", category: "Fish", lifespan: "15-30 years"},
                {name: "OCTOPUS", bpm: 45, size: 18, heartMass: "3g", scientificName: "Octopus vulgaris", category: "Mollusk", lifespan: "1-5 years"},
                {name: "CRAB", bpm: 200, size: 10, heartMass: "0.5g", scientificName: "Callinectes sapidus", category: "Crustacean", lifespan: "2-3 years"},
                {name: "SHRIMP", bpm: 350, size: 6, heartMass: "0.1g", scientificName: "Penaeus vannamei", category: "Crustacean", lifespan: "1-2 years"},
                
                // Small mammals
                {name: "MOUSE", bpm: 600, size: 8, heartMass: "0.1g", scientificName: "Mus musculus", category: "Mammal", lifespan: "1-3 years"},
                {name: "HAMSTER", bpm: 450, size: 10, heartMass: "0.5g", scientificName: "Mesocricetus auratus", category: "Mammal", lifespan: "2-3 years"},
                {name: "RABBIT", bpm: 220, size: 18, heartMass: "6g", scientificName: "Oryctolagus cuniculus", category: "Mammal", lifespan: "8-12 years"},
                
                // Common pets
                {name: "CAT", bpm: 180, size: 25, heartMass: "15g", scientificName: "Felis catus", category: "Mammal", lifespan: "12-18 years"},
                {name: "DOG", bpm: 120, size: 35, heartMass: "150g", scientificName: "Canis familiaris", category: "Mammal", lifespan: "10-13 years"},
                
                // Farm birds (food)
                {name: "CHICKEN", bpm: 280, size: 22, heartMass: "10g", scientificName: "Gallus gallus", category: "Bird", lifespan: "5-10 years"},
                {name: "DUCK", bpm: 190, size: 24, heartMass: "8g", scientificName: "Anas platyrhynchos", category: "Bird", lifespan: "5-10 years"},
                {name: "TURKEY", bpm: 93, size: 38, heartMass: "45g", scientificName: "Meleagris gallopavo", category: "Bird", lifespan: "10 years"},
                {name: "GOOSE", bpm: 120, size: 42, heartMass: "65g", scientificName: "Anser anser", category: "Bird", lifespan: "20-30 years"},
                {name: "QUAIL", bpm: 250, size: 12, heartMass: "0.58g", scientificName: "Coturnix coturnix", category: "Bird", lifespan: "3-5 years"},
                {name: "PIGEON", bpm: 350, size: 16, heartMass: "4g", scientificName: "Columba livia", category: "Bird", lifespan: "6 years"},
                {name: "OSTRICH", bpm: 60, size: 95, heartMass: "900g", scientificName: "Struthio camelus", category: "Bird", lifespan: "40-45 years"},
                
                // Farm mammals (food)
                {name: "PIG", bpm: 85, size: 65, heartMass: "500g", scientificName: "Sus scrofa", category: "Mammal", lifespan: "15-20 years"},
                {name: "SHEEP", bpm: 75, size: 55, heartMass: "250g", scientificName: "Ovis aries", category: "Mammal", lifespan: "10-12 years"},
                {name: "GOAT", bpm: 90, size: 48, heartMass: "200g", scientificName: "Capra hircus", category: "Mammal", lifespan: "15-18 years"},
                {name: "COW", bpm: 65, size: 85, heartMass: "2500g", scientificName: "Bos taurus", category: "Mammal", lifespan: "18-22 years"},
                {name: "BUFFALO", bpm: 55, size: 90, heartMass: "3200g", scientificName: "Bubalus bubalis", category: "Mammal", lifespan: "20-25 years"},
                {name: "DEER", bpm: 70, size: 52, heartMass: "300g", scientificName: "Odocoileus virginianus", category: "Mammal", lifespan: "10-13 years"},
                {name: "CAMEL", bpm: 50, size: 88, heartMass: "4500g", scientificName: "Camelus dromedarius", category: "Mammal", lifespan: "40-50 years"},
                {name: "YAK", bpm: 45, size: 92, heartMass: "5000g", scientificName: "Bos grunniens", category: "Mammal", lifespan: "20-25 years"},
                
                // Working animals
                {name: "HORSE", bpm: 38, size: 95, heartMass: "4000g", scientificName: "Equus caballus", category: "Mammal", lifespan: "25-30 years"},
                
                // Humans
                {name: "HUMAN", bpm: 72, size: 50, heartMass: "300g", scientificName: "Homo sapiens", category: "Mammal", lifespan: "70-80 years"},
                
                // Large birds (slow hearts)
                {name: "SWAN", bpm: 80, size: 58, heartMass: "35g", scientificName: "Cygnus olor", category: "Bird", lifespan: "20-30 years"},
                {name: "EMU", bpm: 27, size: 75, heartMass: "29.92g", scientificName: "Dromaius novaehollandiae", category: "Bird", lifespan: "10-20 years"},
                {name: "CASSOWARY", bpm: 26, size: 80, heartMass: "37.66g", scientificName: "Casuarius casuarius", category: "Bird", lifespan: "40-50 years"}
            ];
            
            tooltip = document.getElementById('tooltip');
            initializeAnimals();
            updateDisplay();
            
            // Set up event listeners
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('sortSelect').addEventListener('change', handleSort);
            
            // Handle window resize
            window.addEventListener('resize', handleResize);
            
            // Mouse events for tooltip
            canvas.canvas.addEventListener('mousemove', handleMouseMove);
            canvas.canvas.addEventListener('mouseleave', hideTooltip);
            
            // Touch events for mobile
            canvas.canvas.addEventListener('touchstart', handleTouchStart);
            canvas.canvas.addEventListener('touchmove', handleTouchMove);
            canvas.canvas.addEventListener('touchend', handleTouchEnd);
            
            // Show intro modal on first load
            setTimeout(() => {
                document.getElementById('introModal').style.display = 'flex';
            }, 500);
            
            // Initialize audio (will be enabled after user interaction)
            initAudio();
        }
        
        function initializeAnimals() {
            for (let animal of allAnimals) {
                animal.phase = 0;
                animal.intensity = 0;
                animal.lastBeat = 0;
                animal.beatInterval = 60000 / animal.bpm;
                animal.x = 0;
                animal.y = 0;
            }
        }
        
        function updateDisplay() {
            // Filter animals based on search
            if (searchTerm) {
                visibleAnimals = allAnimals.filter(animal => 
                    animal.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            } else {
                visibleAnimals = [...allAnimals];
            }
            
            // Sort animals
            if (currentSort === 'alphabetical') {
                visibleAnimals.sort((a, b) => a.name.localeCompare(b.name));
            } else if (currentSort === 'heartrate') {
                visibleAnimals.sort((a, b) => a.bpm - b.bpm);
            } else if (currentSort === 'size') {
                visibleAnimals.sort((a, b) => b.size - a.size);
            }
            
            // Calculate responsive grid layout with optimized spacing
            let screenWidth = window.innerWidth;
            let screenHeight = window.innerHeight - 200; // Account for header + footer
            
            let numAnimals = visibleAnimals.length;
            if (numAnimals === 0) return;
            
            // Better column calculation for more efficient use of space
            if (screenWidth < 480) {
                cols = Math.min(3, numAnimals);
            } else if (screenWidth < 768) {
                cols = Math.min(4, numAnimals);
            } else if (screenWidth < 1024) {
                cols = Math.min(6, numAnimals);
            } else if (screenWidth < 1440) {
                cols = Math.min(8, numAnimals);
            } else {
                cols = Math.min(10, numAnimals);
            }
            
            // Ensure we don't have more columns than animals
            cols = Math.min(cols, numAnimals);
            rows = Math.ceil(numAnimals / cols);
            
            // Optimized margins and spacing
            let marginX = Math.max(20, screenWidth * 0.03);
            let marginY = Math.max(30, screenHeight * 0.05);
            let availableWidth = screenWidth - (marginX * 2);
            let availableHeight = screenHeight - (marginY * 2);
            
            // Calculate cell dimensions
            let cellWidth = availableWidth / cols;
            let cellHeight = availableHeight / rows;
            
            // Find the maximum heart size to ensure proper spacing
            let maxHeartSize = Math.max(...visibleAnimals.map(a => a.size));
            
            // More efficient scaling to fit more animals
            let maxContentHeight = cleanView ? maxHeartSize * 2.5 : maxHeartSize * 2.5 + 50;
            let maxContentWidth = maxHeartSize * 2.5;
            
            // Scale factor based on available cell space
            let scaleFactorX = Math.min(1.2, (cellWidth - 30) / maxContentWidth);
            let scaleFactorY = Math.min(1.2, (cellHeight - 30) / maxContentHeight);
            let scaleFactor = Math.min(scaleFactorX, scaleFactorY);
            
            // Minimum scale to keep hearts visible
            scaleFactor = Math.max(0.2, Math.min(scaleFactor, 1.0));
            
            // Position animals with optimized spacing
            for (let i = 0; i < visibleAnimals.length; i++) {
                let col = i % cols;
                let row = Math.floor(i / cols);
                
                // Center animals in their cells
                visibleAnimals[i].x = marginX + (col * cellWidth) + (cellWidth / 2);
                visibleAnimals[i].y = marginY + (row * cellHeight) + (cellHeight / 2);
                
                // Apply optimized scaling to heart sizes
                visibleAnimals[i].displaySize = visibleAnimals[i].size * scaleFactor;
            }
        }
        
        function draw() {
            // Set background based on theme
            if (isDarkTheme) {
                background(26, 26, 26);
            } else {
                background(245, 245, 245);
            }
            
            let currentTime = millis();
            
            // Update and draw each visible animal
            for (let animal of visibleAnimals) {
                updateHeartbeat(animal, currentTime);
                drawHeart(animal);
                drawLabel(animal); // Always draw labels (function handles clean view internally)
            }
            
            // Draw instructions if no animals visible
            if (visibleAnimals.length === 0) {
                fill(isDarkTheme ? 100 : 150);
                textAlign(CENTER, CENTER);
                textSize(16);
                text("No animals found matching your search", width/2, height/2);
            }
        }
        
        function updateHeartbeat(animal, currentTime) {
            if (currentTime - animal.lastBeat >= animal.beatInterval) {
                animal.lastBeat = currentTime;
                animal.phase = 0;
                
                // Play audio heartbeat when visual heart flickers
                if (hoveredAnimal === animal) {
                    createHeartbeat(animal);
                }
            }
            
            let beatProgress = (currentTime - animal.lastBeat) / animal.beatInterval;
            
            if (beatProgress < 0.1) {
                animal.intensity = map(beatProgress, 0, 0.1, 0, 1);
                animal.intensity = easeOutQuart(animal.intensity);
            } else if (beatProgress < 0.3) {
                animal.intensity = map(beatProgress, 0.1, 0.3, 1, 0.2);
                animal.intensity = easeInQuart(animal.intensity);
            } else {
                animal.intensity = map(beatProgress, 0.3, 1, 0.2, 0);
                animal.intensity = max(0, animal.intensity);
            }
        }
        
        function drawHeart(animal) {
            push();
            translate(animal.x, animal.y);
            
            let baseSize = animal.displaySize || animal.size;
            let currentSize = baseSize + (animal.intensity * baseSize * 0.6);
            
            let red = isDarkTheme ? 255 : 214;
            let green = map(animal.intensity, 0, 1, 0, 50);
            let blue = map(animal.intensity, 0, 1, 0, isDarkTheme ? 50 : 132);
            let alpha = map(animal.intensity, 0, 1, 150, 255);
            
            // Glow effect
            if (animal.intensity > 0.1) {
                let glowSize = currentSize * 1.8;
                let glowAlpha = animal.intensity * 60;
                
                for (let i = 0; i < 4; i++) {
                    let size = map(i, 0, 3, currentSize, glowSize);
                    let a = map(i, 0, 3, glowAlpha, 0);
                    fill(red, 0, 0, a);
                    noStroke();
                    ellipse(0, 0, size);
                }
            }
            
            // Main heart dot
            fill(red, green, blue, alpha);
            noStroke();
            ellipse(0, 0, currentSize);
            
            // Core highlight
            fill(255, 100, 100, animal.intensity * 150);
            ellipse(-currentSize/6, -currentSize/6, currentSize/4);
            
            pop();
        }
        
        function drawLabel(animal) {
            push();
            
            let baseSize = animal.displaySize || animal.size;
            let scaleFactor = Math.max(0.6, Math.min(1.2, baseSize / 20));
            
            // Always show animal name
            fill(isDarkTheme ? 255 : 51, isDarkTheme ? 255 : 51, isDarkTheme ? 255 : 51, 200);
            textAlign(CENTER);
            textSize(Math.max(8, 9 * scaleFactor));
            textStyle(BOLD);
            text(animal.name, animal.x, animal.y - baseSize - 12);
            
            // Show additional info only when NOT in clean view
            if (!cleanView) {
                fill(isDarkTheme ? 255 : 214, 100, isDarkTheme ? 100 : 132, 180);
                textSize(Math.max(7, 8 * scaleFactor));
                textStyle(NORMAL);
                text(animal.bpm + " BPM", animal.x, animal.y + baseSize + 10);
                
                fill(isDarkTheme ? 150 : 102, isDarkTheme ? 150 : 102, isDarkTheme ? 150 : 102, 150);
                textSize(Math.max(6, 7 * scaleFactor));
                text(animal.heartMass, animal.x, animal.y + baseSize + 20);
            }
            
            pop();
        }
        
        function handleMouseMove(event) {
            let rect = event.target.getBoundingClientRect();
            let mouseX = event.clientX - rect.left;
            let mouseY = event.clientY - rect.top;
            
            checkAnimalHover(mouseX, mouseY, event);
        }
        
        function handleTouchStart(event) {
            event.preventDefault(); // Prevent scrolling
            let touch = event.touches[0];
            let rect = event.target.getBoundingClientRect();
            let touchX = touch.clientX - rect.left;
            let touchY = touch.clientY - rect.top;
            
            checkAnimalHover(touchX, touchY, event);
        }
        
        function handleTouchMove(event) {
            event.preventDefault(); // Prevent scrolling
            let touch = event.touches[0];
            let rect = event.target.getBoundingClientRect();
            let touchX = touch.clientX - rect.left;
            let touchY = touch.clientY - rect.top;
            
            checkAnimalHover(touchX, touchY, event);
        }
        
        function handleTouchEnd(event) {
            event.preventDefault();
            hideTooltip();
        }
        
        function checkAnimalHover(x, y, event) {
            let previousHoveredAnimal = hoveredAnimal;
            hoveredAnimal = null;
            
            // Check if touch/mouse is over any animal
            for (let animal of visibleAnimals) {
                let distance = dist(x, y, animal.x, animal.y);
                let baseSize = animal.displaySize || animal.size;
                
                if (distance < baseSize + 15) { // Slightly larger hit area for mobile
                    hoveredAnimal = animal;
                    showTooltip(event, animal, x, y);
                    
                    // Start heartbeat audio if this is a new animal
                    if (previousHoveredAnimal !== animal) {
                        stopHeartbeatAudio();
                        startHeartbeatAudio(animal);
                    }
                    return;
                }
            }
            
            // If no animal is hovered, stop audio and hide tooltip
            if (previousHoveredAnimal !== null) {
                stopHeartbeatAudio();
            }
            hideTooltip();
        }
        
        function showTooltip(event, animal, x, y) {
            tooltip.innerHTML = `
                <h4>${animal.name}</h4>
                <div class="stat">
                    <span class="stat-label">Scientific Name:</span>
                    <span class="stat-value">${animal.scientificName}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Heart Rate:</span>
                    <span class="stat-value">${animal.bpm} BPM</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Heart Size:</span>
                    <span class="stat-value">${animal.size}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Heart Mass:</span>
                    <span class="stat-value">${animal.heartMass}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Category:</span>
                    <span class="stat-value">${animal.category}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Lifespan:</span>
                    <span class="stat-value">${animal.lifespan}</span>
                </div>
            `;
            
            tooltip.style.display = 'block';
            
            // Calculate tooltip position relative to the animal dot
            let tooltipRect = tooltip.getBoundingClientRect();
            let baseSize = animal.displaySize || animal.size;
            
            // Position tooltip with coordinates passed in (works for both mouse and touch)
            let spacing = 12;
            let dotRadius = (baseSize + (animal.intensity * baseSize * 0.6)) / 2;
            
            // Use provided coordinates or fall back to animal position
            let posX = x !== undefined ? x : animal.x;
            let posY = y !== undefined ? y : animal.y;
            
            // Try positioning tooltip to the right first
            let tooltipX = posX + dotRadius + spacing;
            let tooltipY = posY - tooltipRect.height / 2;
            
            // Check if tooltip goes off the right edge of screen
            if (tooltipX + tooltipRect.width > window.innerWidth - 10) {
                // Position to the left instead
                tooltipX = posX - dotRadius - spacing - tooltipRect.width;
            }
            
            // Check if tooltip goes off the left edge
            if (tooltipX < 10) {
                // Position above or below instead
                tooltipX = posX - tooltipRect.width / 2;
                
                // Try above first
                tooltipY = posY - dotRadius - spacing - tooltipRect.height;
                
                // If above goes off screen, position below
                if (tooltipY < 10) {
                    tooltipY = posY + dotRadius + spacing;
                }
            }
            
            // Final boundary checks
            tooltipX = Math.max(10, Math.min(tooltipX, window.innerWidth - tooltipRect.width - 10));
            tooltipY = Math.max(10, Math.min(tooltipY, window.innerHeight - tooltipRect.height - 10));
            
            tooltip.style.left = tooltipX + 'px';
            tooltip.style.top = tooltipY + 'px';
        }
        
        function hideTooltip() {
            tooltip.style.display = 'none';
            hoveredAnimal = null;
            stopHeartbeatAudio();
        }
        
        function toggleCleanView() {
            cleanView = !cleanView;
            let btn = document.getElementById('cleanViewBtn');
            if (cleanView) {
                btn.textContent = 'üìã';
                btn.title = 'Show details';
                btn.classList.add('active');
            } else {
                btn.textContent = 'üßπ';
                btn.title = 'Clean view';
                btn.classList.remove('active');
            }
        }
        
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            let btn = document.getElementById('themeBtn');
            let body = document.body;
            
            if (isDarkTheme) {
                body.setAttribute('data-theme', 'dark');
                btn.textContent = 'üåô';
                btn.title = 'Switch to light mode';
            } else {
                body.setAttribute('data-theme', 'light');
                btn.textContent = '‚òÄÔ∏è';
                btn.title = 'Switch to dark mode';
            }
        }
        
        function closeIntroModal() {
            document.getElementById('introModal').style.display = 'none';
            
            // Enable audio after user interaction
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    isAudioEnabled = true;
                });
            }
        }
        
        function requestAnimal() {
            let animalName = prompt("What animal would you like to see added?\n\nPlease enter the animal name:");
            
            if (animalName && animalName.trim() !== '') {
                // Create mailto link
                let subject = encodeURIComponent("Animal Request for Heartbeat Database");
                let body = encodeURIComponent(`Hello!\n\nI would like to request adding the following animal to the Animal Heartbeat Database:\n\nAnimal: ${animalName.trim()}\n\nThanks!`);
                let mailtoLink = `mailto:your-email@example.com?subject=${subject}&body=${body}`;
                
                // Open email client
                window.location.href = mailtoLink;
                
                // Show confirmation
                alert(`Thank you! Your request for "${animalName.trim()}" will be sent via email.`);
            }
        }
        
        function showExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }
        
        function exportScreenshot() {
            // Temporarily enable clean view for export
            let originalCleanView = cleanView;
            cleanView = true;
            
            // Redraw one frame with clean view
            draw();
            
            // Save the canvas
            saveCanvas('rhythms-of-life-heartbeats', 'png');
            
            // Restore original clean view setting
            cleanView = originalCleanView;
            
            closeExportModal();
        }
        
        function copyLink() {
            const currentUrl = window.location.href;
            
            // Copy to clipboard
            navigator.clipboard.writeText(currentUrl).then(() => {
                alert('Link copied to clipboard! üìã‚ú®');
                closeExportModal();
            }).catch(() => {
                // Fallback for older browsers
                prompt('Copy this link:', currentUrl);
                closeExportModal();
            });
        }
        
        function pledgeToProtect() {
            // Open PETA website in a new tab
            window.open('https://www.peta.org/', '_blank');
            closeExportModal();
        }
        
        function handleResize() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight - 200; // Reserve space for header + footer
            resizeCanvas(canvasWidth, canvasHeight);
            updateDisplay();
        }
        
        function handleSearch() {
            searchTerm = document.getElementById('searchInput').value;
            updateDisplay();
        }
        
        function handleSort() {
            currentSort = document.getElementById('sortSelect').value;
            updateDisplay();
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchTerm = '';
            updateDisplay();
        }
        
        function easeOutQuart(t) {
            return 1 - pow(1 - t, 4);
        }
        
        function easeInQuart(t) {
            return t * t * t * t;
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'c' || event.key === 'C') {
                toggleCleanView();
            } else if (event.key === 't' || event.key === 'T') {
                toggleTheme();
            } else if (event.key === 'e' || event.key === 'E') {
                showExportModal();
            } else if (event.key === 'Escape') {
                closeExportModal();
                closeIntroModal();
                hideTooltip();
            }
        });
        
        // Close modal when clicking outside
        document.getElementById('exportModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeExportModal();
            }
        });
        
        document.getElementById('introModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeIntroModal();
            }
        });
    </script>
</body>
</html>